# minotaur-recipes

![](docs/images/Poseidon-Logo-WaterGraphicLrg.png)

This repository holds all the recipes used to run the Poseidon Framework's
**Minotaur Workflow** and create poseidon packages.

The Minotaur workflow takes in sequencing metadata and URLs of publicly archived
raw sequencing data (provided by the community) and processes them in a flexibly
configurable yet reproducible manner to produce poseidon packages. These
poseidon packages are then added to the Poseidon Minotaur Archive (PMA), and
made available to everyone through
[`trident`](https://github.com/poseidon-framework/poseidon-hs), the poseidon
server-client infrastructure.

# Requesting package addition or update

Anyone can request the addition of a new package to the PMA, or the update of
an existing package by [opening an issue](https://github.com/poseidon-framework/minotaur-recipes/issues/new/choose)
on this repository.

## Package addition

To request a new package, please fill in the `Please add: [PACKAGE_NAME]` issue template.
In the opened issue you will need to:

 - Confirm that the package you are requesting is not already in the PMA
 - Confirm that the package has not already been requested
 - Confirm that the package recipe is not already being prepared
 - Confirm that the package recipe is not already present in the repository

You also need to provide the **doi** of the publication as well as the **project accession** and **URL** to the ENA entry of the data.

## Package update

To request updates to the recipe of an existing package, please fill in the `Please update: [PACKAGE_NAME]` issue template.
In the opened issue you will need to:

- Provide the name of the package to be updated
- check for any open issues or pull requests for the package that contain the updates you want to request
- Explain the changes you want to make to the package recipe
- (optional) Specify the exact nf-core/eager parameters and/or values that you want to change.
- (optional) Explain how you realised that the package recipe needs to be updated

# Contributing to the Poseidon Minotaur Archive

Detailed instructions on how to contribute recipes to this repository can be found in the [Poseidon Framework website](https://www.poseidon-adna.org/#/minotaur).

# The Minotaur Workflow

![Flowchart of the Minotaur Workflow](docs/images/Minotaur_Workflow.jpg)

The Minotaur Workflow consists of three parts:

- Creating the Poseidon Package recipe
- Processing of the public data with [nf-core/eager](https://nf-co.re/eager)
- Poseidon Package preparation for upload to the PMA

Details on each part can be found below.

## Creating a Poseidon Package recipe

This is the community-facing entrypoint to the workflow, and takes place on the
[minotaur-recipes GitHub repository](https://github.com/poseidon-framework/minotaur-recipes),
when a contributor has opened a pull request to add/update a package. Once the
required SSF file has been updated, `delphis-bot` will create all the
SSF-associated auxilliary files required for processing.

Upon activation, `delphis-bot` will create:

- a precursor nf-core/eager TSV input file,
- the package `.config` file,
- the package `tsv_patch.sh` that can be ued to localise the TSV precursor into
  a valid input for nf-core/eager,
- a `script_versions.txt` file, with the versions of the scripts used during the
  package recipe creation.

For a step-by-step guide on how to contribute to the PMA, see
[this guide](docs/contributing.md).

## Processing of data with nf-core/eager

This step takes place locally at [MPI-EVA](https://www.eva.mpg.de/index). The
machinery described in the
[poseidon-eager GitHub repository](https://github.com/poseidon-framework/poseidon-eager)
uses the package recipe to:

- download the raw data from the public archive URLs in the SSF file (using
  `scripts/download_ena_data.py` and `scripts/run_download.sh`)
- Validate the downloaded data, and create symlinks with clearer naming
  (`scripts/validate_downloaded_data.sh`). This allows the one-to-many
  relationship between raw data and `poseidon_ids`.
- Apply the `*_tsv_patch.sh` of the package recipe to create the finalised
  nf-core/eager TSV.
- Use `run_eager.sh` to run nf-core/eager.
  - This uses the finalised TSV as its input
  - And load the `.config` of the package recipe to apply all default
    parameters, as well as any relevant `CaptureType` and package-specific
    parameters.

Once the data is processed, the genotyping output of nf-core/eager is used to
create a poseidon package. The metadata included in the janno file for this
package is then filled using descriptive statistics generated by nf-core/eager
and information from the SSF file.

## Creation of the Poseidon Package

The processed data and its metadata are pulled together to create a poseidon package
using the script `scripts/minotaur_packager.sh`. The output of this script is a
"half-baked package" that is then uploaded to the PMA as a Pull Request. Any additional metadata for the package are then added to the janno file of the package on the Pull Request, prior to merging.